// /utils/saveFiles.js
import fs from "fs";
import path from "path";

/* ==================================================
   saveFiles
   --------------------------------------------------
   این تابع فایل‌های دریافتی از formData را:
   1- بررسی می‌کند
   2- در مسیر public/uploads ذخیره می‌کند
   3- فقط آدرس فایل‌ها را برمی‌گرداند (برای MongoDB)
   ================================================== */

export async function saveFiles(files, folderName) {
  // آرایه‌ای برای ذخیره مسیر فایل‌ها
  const savedPaths = [];

  // مسیر اصلی ذخیره فایل‌ها
  // process.cwd() = ریشه پروژه Next.js
  const uploadDir = path.join(
    process.cwd(),
    "public",
    "uploads",
    "products",
    folderName
  );

  /* ----------------------------------------------
     اگر پوشه وجود نداشت، ساخته می‌شود
     recursive = ساخت کل مسیر در صورت نیاز
  ---------------------------------------------- */
  if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
  }

  /* ----------------------------------------------
     پردازش تک‌تک فایل‌ها
     چون امکان ارسال چند فایل وجود دارد
  ---------------------------------------------- */
  for (const file of files) {
    // اگر فایل خالی یا اشتباه بود، رد شود
    if (!file || typeof file === "string") continue;

    /* --------------------------------------------
       تبدیل فایل به Buffer
       چون fs فقط با Buffer کار می‌کند
    -------------------------------------------- */
    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);

    /* --------------------------------------------
       ساخت نام یکتا برای فایل
       جلوگیری از تداخل اسم فایل‌ها
    -------------------------------------------- */
    const fileName = `${Date.now()}-${file.name}`;

    // مسیر کامل فایل روی سرور
    const filePath = path.join(uploadDir, fileName);

    /* --------------------------------------------
       ذخیره فایل روی File System
    -------------------------------------------- */
    fs.writeFileSync(filePath, buffer);

    /* --------------------------------------------
       ذخیره مسیر public فایل
       (همین مقدار داخل Mongo ذخیره می‌شود)
    -------------------------------------------- */
    savedPaths.push(`/uploads/products/${folderName}/${fileName}`);
  }

  /* ----------------------------------------------
     خروجی:
     آرایه‌ای از مسیر عکس‌ها
  ---------------------------------------------- */
  return savedPaths;
}
